// friendblur global namespace
function InitializeFriendblur(a){$.getJSON("https://graph.facebook.com/me?"+a+"&callback=?",function(a){Friendblur.user=new Friendblur.Models.User(a),Friendblur.statistics=new Friendblur.Views.StatisticsView,Friendblur.statistics.render()})}var Friendblur={Facebook:{},Views:{},Models:{},Collections:{}};Friendblur.Models.User=Backbone.Model.extend({initialize:function(a){Friendblur.friends=new Friendblur.Collections.Friends,Friendblur.friends.from_facebook("https://graph.facebook.com/me/friends?"+Friendblur.Facebook.access_token)}}),Friendblur.Models.Friend=Backbone.Model.extend({initialize:function(a){var b=window.location.protocol+"//"+window.location.hostname+"/api/picture?friend_id="+a.id+"&"+Friendblur.Facebook.access_token;this.set("profile_photo_url",b)}}),Friendblur.Models.Statistic=Backbone.Model.extend({idAttribute:"facebook_id"}),Friendblur.Collections.Statistics=Backbone.Collection.extend({model:Friendblur.Models.Statistic,url:"/api/statistics"}),Friendblur.Collections.Friends=Backbone.Collection.extend({model:Friendblur.Models.Friend,from_facebook:function(a){$.getJSON(a+"&callback=?",function(a){Friendblur.friends.add(a.data),"next"in a.paging?Friendblur.friends.from_facebook(a.paging.next):(Friendblur.friend_names=Friendblur.friends.pluck("name"),Friendblur.game_round=new Friendblur.Views.GameRoundView,Friendblur.game_round.start())})}}),Friendblur.Views.StatisticsView=Backbone.Views.extend({el:"#statistics",initialize:function(){this.statistics=new Friendblur.Collections.Statistics,this.statistics.fetch()},render:function(){}}),Friendblur.Views.InputViews=Backbone.View.extend({initialize:function(){this.whatever=this,this.els=[new Friendblur.Views.InputView(1),new Friendblur.Views.InputView(2),new Friendblur.Views.InputView(3)],_.each(this.els,function(a){a.on("guess-attempt",function(a){this.trigger("guess-attempt",a)}.bind(this))}.bind(this))},destroy:function(){_.each(this.els,function(a){a.off("guess-attempt")})},disable:function(){for(var a=0;a<this.els.length;a++)this.els[a].disable()},enable:function(){for(var a=0;a<this.els.length;a++)this.els[a].enable()},reset:function(){for(var a=0;a<this.els.length;a++)this.els[a].reset(),this.els[a].enable()}}),Friendblur.Views.InputView=Backbone.View.extend({initialize:function(a){this.el="#guess-input"+a,this.el_icon=this.el+" .result-icon",this.el_container="#search-container"+a,this.index=a,$(this.el).typeahead({source:Friendblur.friend_names}).change(function(b){var c=Friendblur.game_round.friends.random_friends[a-1].friend.get("name");this.remove_classes(),c===$(this.el).val()?(this.success(),this.trigger("guess-attempt",{success:!0,index:this.index})):(this.failure(),this.trigger("guess-attempt",{success:!1,index:this.index})),this.disable()}.bind(this))},reset:function(){this.remove_classes(),$(this.el).val(""),$(this.el_icon).addClass("icon-search")},enable:function(){$(this.el).attr("disabled",!1)},disable:function(){$(this.el).attr("disabled",!0)},remove_classes:function(){$(this.el_container).hasClass("error")&&$(this.el_container).removeClass("error"),$(this.el_icon).hasClass("icon-remove")&&$(this.el_icon).removeClass("icon-remove"),$(this.el_container).hasClass("success")&&$(this.el_container).removeClass("success"),$(this.el_icon).hasClass("icon-ok")&&$(this.el_icon).removeClass("icon-ok"),$(this.el_icon).hasClass("icon-search")&&$(this.el_icon).removeClass("icon-search")},success:function(){$(this.el_container).addClass("success"),$(this.el_icon).addClass("icon-ok")},failure:function(){$(this.el_container).addClass("error"),$(this.el_icon).addClass("icon-remove")}}),Friendblur.Views.FriendView=Backbone.View.extend({initialize:function(a){this.el="#image-source"+a,this.blur_el="#image-destination"+a,this.name_el="#friend-name"+a,this.index=a},set_friend:function(a){this.friend=a},render:function(a){$(this.el).css("background-image","url("+this.friend.get("profile_photo_url")+")"),$(this.blur_el).blurjs({radius:a,source:this.el})},show_name:function(){$(this.name_el).html(this.friend.get("name"))},hide_name:function(){$(this.name_el).html("")}}),Friendblur.Views.RandomFriendsView=Backbone.View.extend({initialize:function(){this.random_friends=[new Friendblur.Views.FriendView(1),new Friendblur.Views.FriendView(2),new Friendblur.Views.FriendView(3)]},render:function(a){for(var b=0;b<3;b++)this.random_friends[b].render(a)},randomize:function(){var a=[];while(a.length<3){var b=Math.floor(Math.random()*Friendblur.friends.length);$.inArray(b,a)<0&&a.push(b)}for(var c=0;c<3;c++)this.random_friends[c].set_friend(Friendblur.friends.at(a[c]))},show_names:function(){for(var a=0;a<this.random_friends.length;a++)this.random_friends[a].show_name()},hide_names:function(){for(var a=0;a<this.random_friends.length;a++)this.random_friends[a].hide_name()}}),Friendblur.Views.StopRoundView=Backbone.View.extend({el:"#success-modal",initialize:function(){this.inputs=new Friendblur.Views.InputViews},start:function(){$(this.el).modal("show"),$(this.el).on("hidden",function(){this.destroy()}.bind(this)),this.submit_stats({facebook_id:Friendblur.user.get("id"),facebook_name:Friendblur.user.get("first_name"),success:!0}),mixpanel.track("successful round")},destroy:function(){$(this.el).off("hidden"),this.inputs.destroy(),Friendblur.game_round=new Friendblur.Views.WaitRoundView,Friendblur.game_round.start()},submit_stats:function(a){$.post("/api/statistics",{stats_payload:a},function(a){console.dir(a)})}}),Friendblur.Views.WaitRoundView=Backbone.View.extend({el:"#round-timer",initialize:function(){this.time_remaining=10,this.inputs=new Friendblur.Views.InputViews},start:function(){this.inputs.disable(),this.timer_id=setInterval(this.tick.bind(this),1e3)},tick:function(){this.time_remaining>0?($(this.el).html("round over! starting new round in "+this.time_remaining+" seconds."),this.time_remaining=this.time_remaining-1):(clearInterval(this.timer_id),this.inputs.destroy(),Friendblur.game_round=new Friendblur.Views.GameRoundView,Friendblur.game_round.start())}}),Friendblur.Views.GameRoundView=Backbone.View.extend({el:"#round-timer",initialize:function(){this.successes=0,this.blur_radius=10,this.time_remaining=15,this.friends=new Friendblur.Views.RandomFriendsView,this.inputs=new Friendblur.Views.InputViews,this.inputs.on("guess-attempt",function(a){a.success==1?(this.successes=this.successes+1,this.successes>=3&&(this.time_remaining=0),mixpanel.track("successful guess")):mixpanel.track("failed guess")}.bind(this))},destroy:function(){this.inputs.off("guess-attempt")},start:function(){this.friends.hide_names(),this.friends.randomize(),this.friends.render(this.blur_radius),this.inputs.reset(),$(this.el).html("seconds left: "+this.time_remaining),this.timer_id=setInterval(this.tick.bind(this),1e3),mixpanel.track("new round")},tick:function(){this.time_remaining>0?($(this.el).html("seconds left: "+this.time_remaining),this.time_remaining%4==0&&(this.blur_radius=this.blur_radius-2,this.friends.render(this.blur_radius)),this.time_remaining=this.time_remaining-1):(clearInterval(this.timer_id),this.friends.show_names(),this.friends.render(0),this.inputs.destroy(),this.destroy(),this.successes>=3?(Friendblur.game_round=new Friendblur.Views.StopRoundView,Friendblur.game_round.start()):(Friendblur.game_round=new Friendblur.Views.WaitRoundView,Friendblur.game_round.start()))}}),$(function(){$("#success-modal").modal({show:!1}),Friendblur.Facebook.app_id="275172692558681";if(window.location.hash.length==0){var a="https://www.facebook.com/dialog/oauth?",b=["client_id="+Friendblur.Facebook.app_id,"redirect_uri="+window.location,"response_type=token"],c=b.join("&");window.location=a+c}Friendblur.Facebook.access_token=window.location.hash.substring(1),InitializeFriendblur(Friendblur.Facebook.access_token)});